<!-- Account.ejs -->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài khoản</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/Account.css">
    <style>
        /* Thêm CSS đơn giản để hiển thị ảnh preview */
        .avatar-preview-container {
            text-align: center;
            margin-bottom: 15px;
        }
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
        }
    </style>
</head>

<body>
<%- include('header.ejs', { loggedInUser: typeof user !== 'undefined' ? user : null }) %>

    <div class="container1">
        <!-- Phần hiển thị thông báo -->
        <div id="successMessage" class="alert alert-success" style="display: none;"></div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        <section class="profile">
            <div class="profile__background"></div>
            <!-- Thay đổi ảnh mặc định và thêm ID nếu muốn cập nhật bằng JS -->
            <div class="profile__avatar"><img src="/images/schwi.png" alt="Avatar của " id="profileMainAvatar"></div>
            <div class="profile__info">
                <h2 class="profile__name" id="profileFullName"></h2>
                <p class="profile__username">@<span id="profileUsername"></span></p>
                <div class="profile__stats">
                    <span><i class="fa fa-book"></i> <span id="storyCount">0</span> Tác phẩm</span>
                    <!-- Thay đổi tại đây: thêm ID cho span bao quanh hoặc toàn bộ khu vực -->
                    <!-- Tốt nhất là thêm ID vào span cha của icon và số để dễ click -->
                    <span id="followersClickableArea"><i class="fa fa-user-friends"></i> <span id="followersCountDisplay">0</span> Người theo dõi</span>
                    <span id="followingClickableArea"><i class="fa fa-users"></i> <span id="followingCountDisplay">0</span> Đang theo dõi</span>
                </div>
                <!-- Nút Follow/Unfollow, chỉ hiện khi xem profile người khác -->
                <button id="followButton" class="btn btn-primary mt-3" style="display:none;"></button>
            </div>
        </section>

        <nav class="tabs">
            <button class="tab tab--active" data-tab="gioithieu"><i class="fa fa-info-circle"></i> Giới thiệu</button>
            <button class="tab" data-tab="hoithoai"><i class="fa fa-comments"></i> Hội thoại</button>
            <!-- Ẩn tab cài đặt nếu đang xem profile của người khác -->
            <button class="tab" data-tab="caidat" id="settingsTab" style="display:none;">
                <i class="fas fa-cog"></i> Cài đặt
            </button>
        </nav>

        <main class="content">
            <section id="gioithieu" class="content__section content__section--active">
                <div class="container2">
                    <div class="row">
                        <div class="col-md-4">
                            <!-- Card Giới thiệu / Mô tả -->
                            <div class="card mb-3">
                                <h3><i class="fa fa-info-circle"></i> Mô tả/Giới thiệu</h3>
                                <p id="profileDescriptionContent" class="profile__description-text">Chưa có mô tả.</p>
                            </div>

                            <!-- Card Đang theo dõi (Hiển thị người mà user hiện tại đang theo dõi) -->
                            <div class="card mb-3" id="followingListCard">
                                <!-- THÊM ID CHO THẺ H3 ĐỂ CÓ THỂ CLICK VÀO TOÀN BỘ DÒNG -->
                                <h3 id="cardFollowingHeaderClickable"><i class="fa fa-heart"></i> Đang theo dõi <span class="badge bg-secondary" id="followingCountInCard">0</span></h3>
                                <div class="following-list" id="followingUsersList">
                                    <!-- Danh sách người đang theo dõi sẽ được thêm vào đây bằng JavaScript -->
                                    <p id="noFollowingMessage" style="display: none;">Chưa theo dõi ai.</p>
                                </div>
                            </div>

                            <!-- Card Người theo dõi (Hiển thị người đang theo dõi user hiện tại) -->
                            <div class="card" id="followersListCard">
                                <!-- THÊM ID CHO THẺ H3 ĐỂ CÓ THỂ CLICK VÀO TOÀN BỘ DÒNG -->
                                <h3 id="cardFollowersHeaderClickable"><i class="fa fa-user-friends"></i> Người theo dõi <span class="badge bg-secondary" id="followersCountInCard">0</span></h3>
                                <div class="following-list" id="followersUsersList">
                                    <!-- Danh sách người theo dõi sẽ được thêm vào đây bằng JavaScript -->
                                    <p id="noFollowersMessage" style="display: none;">Chưa có người theo dõi.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Truyện của <span id="storyName"></span> <i class="fas fa-cog float-end"></i></h3>
                                    <p class="text-muted"><span id="publishedStories">0</span>  • <span id="draftStories">0</span> Truyện đã Đăng</p> <!--Phần này chỉ hiện khi người dùng vào hồ sơ cá nhân-->
                                </div>
                                <div class="work-list" id="workList">
                                    <!-- Story items will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="hoithoai" class="content__section">
                <!-- Giữ nguyên phần bình luận -->
                <div class="card">
                    <div class="title-cmt">Bình luận</div>
                    <div class="cmt">
                        <div class="box-cmt">
                            <form id="commentForm" class="row">
                                <div class="col-10">
                                    <textarea id="commentInput" placeholder="Nhập bình luận của bạn..." required></textarea>
                                </div>
                                <div class="col-2">
                                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </form>
                            <div id="commentsList">
                                <h3>Các bình luận:</h3>
                                <ul id="comments">
                                    <!-- Các bình luận sẽ được thêm vào đây bằng JavaScript -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Phần form chỉnh sửa thông tin tài khoản, chỉ hiện khi xem profile của chính mình -->
            <section id="caidat" class="content__section">
                <div class="card">
                    <h3>Chỉnh sửa thông tin cá nhân</h3>
                    <!-- THÊM enctype="multipart/form-data" để upload file -->
                    <form id="editProfileForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="avatarFile" class="form-label">Cập nhật ảnh đại diện:</label>
                            <div class="avatar-preview-container">
                                <img id="avatarPreview" class="avatar-preview" src="<%= user ? user.avatar : '/images/schwi.png' %>" alt="Ảnh đại diện">
                            </div>
                            <input type="file" class="form-control" id="avatarFile" name="avatarFile" accept="image/*">
                            <small class="form-text text-muted">Chọn một file ảnh (JPG, PNG) để tải lên.</small>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Tên:</label>
                            <input type="text" class="form-control" id="name" name="name" value="<%= user ? user.name : '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" class="form-control" id="email" name="email" value="<%= user ? user.email : '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Điện thoại:</label>
                            <input type="text" class="form-control" id="phone" name="phone" value="<%= user && user.phone ? user.phone : '' %>">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Mô tả/Giới thiệu:</label>
                            <textarea class="form-control" id="description" name="description" rows="5"><%= user && user.description ? user.description : '' %></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Khai báo một biến global JavaScript để lưu trữ ID người dùng
        const LOGGED_IN_USER_ID = "<%= user ? user._id : '' %>";
    </script>
    <script src="../javascript/Account.js"></script>
</body>

</html>